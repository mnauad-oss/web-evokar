<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n | Evokar</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <style>
        body {
            padding: 50px;
            text-align: center;
        }

        .admin-container {
            max-width: 800px;
            margin: 0 auto;
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <h1>Bienvenido Administrador</h1>
        <p>Has iniciado sesi√≥n correctamente.</p>
        <button class="btn-primary" id="logout-btn" style="margin-top: 2rem;">Cerrar Sesi√≥n</button>

        <div id="lista-mensajes" style="text-align: left; margin-top: 20px;">Cargando cotizaciones...</div>

        <script>
            // CONFIGURACI√ìN NETLIFY API
            const API_TOKEN = 'nfp_YFFJi7sZDFriAqvG88rqxNtCckqQyJeHe433';
            const FORM_ID = '69656019b4404b000809065f';
            async function cargarMensajes() {
                const lista = document.getElementById('lista-mensajes');
                lista.innerHTML = "Cargando mensajes...";

                try {
                    const response = await fetch(`https://api.netlify.com/api/v1/forms/${FORM_ID}/submissions`, {
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Estado ${response.status}`);
                    }

                    const mensajes = await response.json();

                    lista.innerHTML = ""; // Limpiar "Cargando..."

                    if (mensajes.length === 0) {
                        lista.innerHTML = "<p>No hay mensajes nuevos.</p>";
                        return;
                    }

                    // Recuperar estado de "respondidos" localmente
                    const respondidos = JSON.parse(localStorage.getItem('respondidos') || '[]');

                    mensajes.forEach(m => {
                        const item = document.createElement('div');
                        const isRespondido = respondidos.includes(m.id);
                        const bgColor = isRespondido ? '#d4edda' : 'transparent'; // Verde claro si est√° respondido
                        const textColor = isRespondido ? '#155724' : '#ddd';
                        const borderColor = isRespondido ? '#c3e6cb' : '#555';

                        item.id = `msg-${m.id}`;
                        item.style.borderBottom = `1px solid ${borderColor}`;
                        item.style.padding = "15px";
                        item.style.marginBottom = "10px";
                        item.style.backgroundColor = bgColor;
                        item.style.color = textColor;
                        item.style.borderRadius = "8px";
                        item.style.transition = "all 0.3s ease";

                        // Smart keys mapping
                        const getField = (obj, keyName) => {
                            if (!obj) return null;
                            const foundKey = Object.keys(obj).find(k => k.toLowerCase() === keyName.toLowerCase());
                            return foundKey ? obj[foundKey] : null;
                        };

                        const nombre = getField(m.data, 'nombre') || getField(m.data, 'name') || 'No indicado';
                        const telefono = getField(m.data, 'telefono') || getField(m.data, 'phone') || getField(m.data, 'tel') || 'No indicado';
                        const mensaje = getField(m.data, 'mensaje') || getField(m.data, 'message') || 'Sin mensaje';

                        // L√≥gica WhatsApp
                        let whatsappBtn = '';
                        if (telefono !== 'No indicado') {
                            const telefonoLimpio = telefono.replace(/\D/g, '');
                            // Asumimos +56 si no viene incluido, pero validamos longitud b√°sica
                            const telefonoFinal = telefonoLimpio.length > 8 ? telefonoLimpio : `56${telefonoLimpio}`;
                            const texto = `Hola ${nombre}, recibimos tu mensaje en Evokar: "${mensaje.substring(0, 20)}...". Te contactamos para coordinar.`;
                            const whatsappUrl = `https://wa.me/${telefonoFinal}?text=${encodeURIComponent(texto)}`;

                            whatsappBtn = `
                                <a href="${whatsappUrl}" target="_blank" style="margin-left: 10px; background: #25d366; color: white; padding: 2px 8px; border-radius: 4px; text-decoration: none; font-size: 0.8rem; vertical-align: middle; display: inline-flex; align-items: center; gap: 4px;">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </a>`;
                        }

                        item.innerHTML = `
                            <div style="margin-bottom: 10px;">
                                <p style="margin: 5px 0;"><strong>Cliente:</strong> ${nombre}</p>
                                <p style="margin: 5px 0;"><strong>Tel√©fono:</strong> ${telefono} ${whatsappBtn}</p>
                                <p style="margin: 5px 0;"><strong>Email:</strong> ${m.email || 'No indicado'}</p>
                                <p style="margin: 5px 0;"><strong>Mensaje:</strong> ${mensaje}</p>
                                <small style="opacity: 0.7;">Recibido el: ${new Date(m.created_at).toLocaleString()}</small>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button onclick="marcarRespondido('${m.id}')" style="padding: 5px 10px; cursor: pointer; background: #28a745; color: white; border: none; border-radius: 4px;">
                                    ${isRespondido ? '‚Ü©Ô∏è Desmarcar' : '‚úÖ Marcar Respondido'}
                                </button>
                                <button onclick="borrarMensaje('${m.id}')" style="padding: 5px 10px; cursor: pointer; background: #dc3545; color: white; border: none; border-radius: 4px;">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        `;
                        lista.appendChild(item);
                    });
                } catch (error) {
                    console.error('Error:', error);
                    lista.innerHTML = `<p style="color: red;">Error cargando mensajes.</p>`;
                }
            }

            // Funci√≥n para marcar como respondido (Persistencia Local)
            window.marcarRespondido = (id) => {
                let respondidos = JSON.parse(localStorage.getItem('respondidos') || '[]');
                const index = respondidos.indexOf(id);
                const item = document.getElementById(`msg-${id}`);

                if (index === -1) {
                    // Marcar
                    respondidos.push(id);
                    item.style.backgroundColor = '#d4edda';
                    item.style.color = '#155724';
                    item.style.borderBottom = '1px solid #c3e6cb';
                    // Actualizar texto bot√≥n (opcional, requerir√≠a buscar el bot√≥n hijo)
                } else {
                    // Desmarcar
                    respondidos.splice(index, 1);
                    item.style.backgroundColor = 'transparent';
                    item.style.color = '#ddd';
                    item.style.borderBottom = '1px solid #555';
                }

                localStorage.setItem('respondidos', JSON.stringify(respondidos));
                // Recargar para actualizar textos de botones si se desea, o dejarlo din√°mico
                cargarMensajes();
            };

            // Funci√≥n para borrar mensaje (API Netlify)
            window.borrarMensaje = async (id) => {
                if (!confirm('¬øEst√°s seguro de eliminar este mensaje permanentemente?')) return;

                const item = document.getElementById(`msg-${id}`);
                item.style.opacity = '0.5';
                item.innerHTML += ' <small>Eliminando...</small>';

                try {
                    const response = await fetch(`https://api.netlify.com/api/v1/submissions/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`
                        }
                    });

                    if (response.ok) {
                        item.remove();
                        // Tambi√©n limpiamos del local storage si estaba ah√≠
                        let respondidos = JSON.parse(localStorage.getItem('respondidos') || '[]');
                        respondidos = respondidos.filter(rid => rid !== id);
                        localStorage.setItem('respondidos', JSON.stringify(respondidos));
                    } else {
                        alert('Error al eliminar mensaje');
                        item.style.opacity = '1';
                    }
                } catch (e) {
                    console.error(e);
                    alert('Error de conexi√≥n al eliminar');
                    item.style.opacity = '1';
                }
            };

            if (window.netlifyIdentity) {
                // Initial check
                // Removed SHOW_DEBUG check here as per instructions

                window.netlifyIdentity.on("init", user => {
                    if (user) {
                        cargarMensajes();
                    }
                });

                const currentUser = window.netlifyIdentity.currentUser();
                if (currentUser) {
                    cargarMensajes();
                }

                // Handle Logout
                window.netlifyIdentity.on("logout", () => {
                    window.location.href = "index.html";
                });
            }

            // Button Listener - Now safe because button is defined above
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    netlifyIdentity.open(); // Open widget to confirm or just logout directly
                    netlifyIdentity.logout();
                });
            }
        </script>
    </div>
</body>

</html>